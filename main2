import telebot
import sqlite3
from datetime import datetime, timedelta

TOKEN = "8495656409:AAHK9Ll3JnKscLVQt1Iw0VF6qMT69iQHfEg"
OWNER_USERNAME = "pounlock"
ALLOWED_CHAT_ID = -1003159585382  

bot = telebot.TeleBot(TOKEN)

# ===== DATABASE =====
conn = sqlite3.connect("ecid.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS ecids (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    username TEXT,
    ecid TEXT UNIQUE,
    created_at TEXT
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS user_limits (
    user_id INTEGER PRIMARY KEY,
    last_register TEXT
)
""")

conn.commit()

# ===== HELPERS =====
def is_group(message):
    return message.chat.id == ALLOWED_CHAT_ID

def reply(message, text):
    bot.send_message(
        message.chat.id,
        text,
        reply_to_message_id=message.message_id,
        parse_mode="Markdown"
    )

# ===== WELCOME (NAME ALLOWED) =====
@bot.message_handler(content_types=['new_chat_members'])
def welcome(message):
    for user in message.new_chat_members:
        name = user.first_name or "User"
        bot.send_message(
            message.chat.id,
            f"üëã Welcome *{name}* to HG Tools!",
            parse_mode="Markdown"
        )

# ===== HELP (NAME ALLOWED) =====
@bot.message_handler(commands=['help'])
def help_cmd(message):
    if not is_group(message):
        return

    name = message.from_user.first_name or "User"
    bot.send_message(
        message.chat.id,
        f"*{name}* üëã Bot usage:\n\n"
        "‚Ä¢ Register ECID:\n`/register <ECID>`\n\n"
        "‚Ä¢ Check ECID:\n`/check <ECID>`\n\n"
        "‚Ä¢ Download:\n`/download`",
        parse_mode="Markdown"
    )

# ===== REGISTER =====
@bot.message_handler(commands=['register'])
def register(message):
    if not is_group(message):
        return

    parts = message.text.split(maxsplit=1)
    if len(parts) != 2:
        reply(message, "‚ùå Format:\n`/register <ECID>`")
        return

    ecid = parts[1].strip()
    user_id = message.from_user.id
    username = message.from_user.username or ""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ ECID
    cursor.execute("SELECT ecid FROM ecids WHERE ecid = ?", (ecid,))
    if cursor.fetchone():
        reply(message, "‚ö†Ô∏è This ECID is already registered")
        return

    # –õ–∏–º–∏—Ç (–∫—Ä–æ–º–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è)
    if username.lower() != OWNER_USERNAME.lower():
        cursor.execute("SELECT last_register FROM user_limits WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()

        if row:
            last_time = datetime.fromisoformat(row[0])
            if datetime.now() - last_time < timedelta(hours=24):
                reply(message, "‚è≥ You can register only **1 ECID per 24 hours**")
                return

        cursor.execute(
            "INSERT OR REPLACE INTO user_limits (user_id, last_register) VALUES (?, ?)",
            (user_id, datetime.now().isoformat())
        )

    # –ó–∞–ø–∏—Å—å ECID
    cursor.execute(
        "INSERT INTO ecids (user_id, username, ecid, created_at) VALUES (?, ?, ?, ?)",
        (user_id, username, ecid, datetime.now().isoformat())
    )
    conn.commit()

    reply(message, f"‚úÖ Registered `{ecid}` successfully!")

# ===== CHECK =====
@bot.message_handler(commands=['check'])
def check_ecid(message):
    if not is_group(message):
        return

    parts = message.text.split(maxsplit=1)
    if len(parts) != 2:
        reply(message, "‚ùå Format:\n`/check <ECID>`")
        return

    ecid = parts[1].strip()

    cursor.execute("SELECT ecid FROM ecids WHERE ecid = ?", (ecid,))
    if cursor.fetchone():
        reply(message, f"‚úÖ ECID `{ecid}` is registered")
    else:
        reply(message, f"‚ùå ECID `{ecid}` not found")

# ===== DOWNLOAD =====
@bot.message_handler(commands=['download'])
def download(message):
    if not is_group(message):
        return

    reply(
        message,
        "üì• Download:\n"
        "üëâ https://www.mediafire.com/file/sgw0wxk4fn6xgb8/PO+Tools+A12+.zip/file"
    )

# ===== START =====
bot.polling(none_stop=True)
